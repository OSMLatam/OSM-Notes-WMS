name: Run Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  formatting:
    name: Code Formatting Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install shfmt
        run: |
          wget -q -O shfmt https://github.com/mvdan/sh/releases/download/v3.7.0/shfmt_v3.7.0_linux_amd64
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/

      - name: Check bash formatting with shfmt
        run: |
          echo "Checking bash code formatting..."
          find bin tests -name "*.sh" -type f -exec shfmt -d {} \;

      - name: Install SQLFluff
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlfluff || pip3 install sqlfluff

      - name: Check SQL formatting
        continue-on-error: true
        run: |
          if command -v sqlfluff &> /dev/null; then
            find sql -name "*.sql" -type f -exec sqlfluff lint {} \; || echo "SQL formatting issues found (non-blocking)"
          fi

      - name: Setup Node.js for Prettier
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Prettier
        run: npm install -g prettier

      - name: Check formatting with Prettier
        continue-on-error: true
        run: |
          prettier --check "**/*.{md,json,yaml,yml,css,html}" --ignore-path .prettierignore 2>/dev/null || echo "Prettier formatting issues found (non-blocking)"

  test:
    runs-on: ubuntu-latest
    needs: formatting

    services:
      postgres:
        image: postgis/postgis:15-3.3
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      TEST_DBNAME: osm_notes_wms_test
      TEST_DBUSER: testuser
      TEST_DBPASSWORD: testpass
      TEST_DBHOST: localhost
      TEST_DBPORT: 5432
      PGPASSWORD: testpass
      DBNAME: osm_notes_wms_test
      DBUSER: testuser
      DBPASSWORD: testpass
      DBHOST: localhost
      DBPORT: 5432
      MOCK_MODE: 0

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install BATS
      run: |
        sudo apt-get update
        sudo apt-get install -y bats

    - name: Install PostgreSQL client tools
      run: |
        sudo apt-get install -y postgresql-client

    - name: Wait for PostgreSQL to be ready
      run: |
        until pg_isready -h localhost -U testuser -d postgres; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
        echo "PostgreSQL is ready!"

    - name: Create test database
      run: |
        PGPASSWORD=testpass createdb -h localhost -U testuser osm_notes_wms_test || echo "Database may already exist"
        PGPASSWORD=testpass psql -h localhost -U testuser -d osm_notes_wms_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"
        echo "Test database created and PostGIS extension enabled"

    - name: Make scripts executable
      run: |
        find bin -type f -name "*.sh" -exec chmod +x {} \;
        find tests -type f -name "*.sh" -exec chmod +x {} \;
        find tests -type f -name "*.bats" -exec chmod +x {} \;

    - name: Run unit tests
      continue-on-error: true
      run: |
        echo "=========================================="
        echo "Running unit tests"
        echo "=========================================="
        bats -r tests/unit/bash/ || echo "Some unit tests may have failed"
        echo "Unit tests completed"

    - name: Run integration tests
      continue-on-error: true
      run: |
        echo "=========================================="
        echo "Running integration tests"
        echo "=========================================="
        bats -r tests/integration/ || echo "Some integration tests may have failed"
        echo "Integration tests completed"

    - name: Test summary
      if: always()
      run: |
        echo "=========================================="
        echo "Test execution completed"
        echo "=========================================="
        echo "Check the output above for detailed test results."

