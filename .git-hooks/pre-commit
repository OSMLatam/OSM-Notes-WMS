#!/bin/bash

# Pre-commit hook for OSM-Notes-WMS
# Unified Git hook for Bash/SQL projects
# Author: Andres Gomez (AngocA)
# Version: 2026-01-27
# Runs quality checks before allowing commit
#
# To install: ln -sf ../../.git-hooks/pre-commit .git/hooks/pre-commit

set -e

echo "üîç Running pre-commit checks..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged files by type
STAGED_SH_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)
STAGED_SQL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sql$' || true)
STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|json|yaml|yml|css|html)$' || true)

if [ -z "$STAGED_SH_FILES" ] && [ -z "$STAGED_SQL_FILES" ] && [ -z "$STAGED_FORMAT_FILES" ]; then
    echo "‚ÑπÔ∏è  No files requiring format checks staged for commit"
    exit 0
fi

# Check 1: Shellcheck (bash scripts)
if [ -n "$STAGED_SH_FILES" ]; then
    if command -v shellcheck &> /dev/null; then
        echo "üîç Running shellcheck..."
        SHELLCHECK_FAILED=0
        
        for file in $STAGED_SH_FILES; do
            if [ -f "$file" ]; then
                # Run shellcheck and capture output, limit to first 5 errors for speed
                SC_OUTPUT=$(shellcheck -x "$file" 2>&1 || true)
                if echo "$SC_OUTPUT" | grep -q "error\|warning"; then
                    SHELLCHECK_FAILED=1
                    echo -e "${RED}‚ùå Shellcheck failed for: $file${NC}"
                    echo "$SC_OUTPUT" | head -5
                fi
            fi
        done
        
        if [ $SHELLCHECK_FAILED -eq 1 ]; then
            echo -e "${RED}‚ùå Shellcheck found issues. Please fix them before committing.${NC}"
            exit 1
        fi
        echo -e "${GREEN}‚úÖ Shellcheck passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Shellcheck not installed, skipping...${NC}"
    fi
    echo ""
fi

# Check 2: Shfmt (bash formatting)
if [ -n "$STAGED_SH_FILES" ]; then
    if command -v shfmt &> /dev/null; then
        echo "üîç Checking bash code formatting..."
        SHFMT_FAILED=0
        
        for file in $STAGED_SH_FILES; do
            if [ -f "$file" ]; then
                if ! shfmt -d -i 1 -sr -bn "$file" > /dev/null 2>&1; then
                    SHFMT_FAILED=1
                    echo -e "${RED}‚ùå Format check failed for: $file${NC}"
                    echo "   Run: shfmt -w -i 1 -sr -bn $file"
                fi
            fi
        done
        
        if [ $SHFMT_FAILED -eq 1 ]; then
            echo -e "${RED}‚ùå Format check failed. Run shfmt to fix formatting.${NC}"
            exit 1
        fi
        echo -e "${GREEN}‚úÖ Format check passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Shfmt not installed, skipping...${NC}"
    fi
    echo ""
fi

# Check 3: Trailing whitespace (bash scripts)
if [ -n "$STAGED_SH_FILES" ]; then
    echo "üîç Checking for trailing whitespace..."
    TRAILING_WS_FAILED=0
    
    for file in $STAGED_SH_FILES; do
        if [ -f "$file" ]; then
            if grep -n ' $' "$file" > /dev/null 2>&1; then
                TRAILING_WS_FAILED=1
                echo -e "${RED}‚ùå Trailing whitespace found in: $file${NC}"
                echo "   Run: sed -i 's/[[:space:]]*$//' $file"
            fi
        fi
    done
    
    if [ $TRAILING_WS_FAILED -eq 1 ]; then
        echo -e "${RED}‚ùå Trailing whitespace found. Please remove it.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ No trailing whitespace${NC}"
    echo ""
fi

# Check 4: Shebang validation (bash scripts)
if [ -n "$STAGED_SH_FILES" ]; then
    echo "üîç Checking shebangs..."
    SHEBANG_FAILED=0
    
    for file in $STAGED_SH_FILES; do
        if [ -f "$file" ]; then
            FIRST_LINE=$(head -1 "$file")
            if [[ "$FIRST_LINE" != "#!/bin/bash"* ]] && [[ "$FIRST_LINE" != "#!/usr/bin/env bash"* ]]; then
                SHEBANG_FAILED=1
                echo -e "${RED}‚ùå Invalid or missing shebang in: $file${NC}"
                echo "   First line: $FIRST_LINE"
            fi
        fi
    done
    
    if [ $SHEBANG_FAILED -eq 1 ]; then
        echo -e "${RED}‚ùå Shebang check failed.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Shebangs OK${NC}"
    echo ""
fi

# Check 5: SQL formatting (SQLFluff)
if [ -n "$STAGED_SQL_FILES" ]; then
    if command -v sqlfluff &> /dev/null; then
        echo "üîç Checking SQL formatting..."
        SQLFLUFF_FAILED=0
        
        for file in $STAGED_SQL_FILES; do
            if [ -f "$file" ]; then
                if ! sqlfluff lint "$file" > /dev/null 2>&1; then
                    SQLFLUFF_FAILED=1
                    echo -e "${RED}‚ùå SQL format check failed for: $file${NC}"
                    echo "   Run: sqlfluff fix $file"
                fi
            fi
        done
        
        if [ $SQLFLUFF_FAILED -eq 1 ]; then
            echo -e "${RED}‚ùå SQL format check failed. Run sqlfluff fix to fix formatting.${NC}"
            exit 1
        fi
        echo -e "${GREEN}‚úÖ SQL format check passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  SQLFluff not installed, skipping SQL format check...${NC}"
    fi
    echo ""
fi

# Check 6: Prettier (Markdown, JSON, YAML, CSS, HTML)
if [ -n "$STAGED_FORMAT_FILES" ]; then
    if command -v prettier &> /dev/null; then
        echo "üîç Checking formatting with Prettier..."
        PRETTIER_FAILED=0
        
        for file in $STAGED_FORMAT_FILES; do
            # Skip XML test fixtures (real OSM dumps, should not be formatted)
            if [[ "$file" == *"tests/fixtures"*".xml" ]]; then
                continue
            fi
            
            if [ -f "$file" ]; then
                if ! prettier --check "$file" > /dev/null 2>&1; then
                    PRETTIER_FAILED=1
                    echo -e "${RED}‚ùå Prettier format check failed for: $file${NC}"
                    echo "   Run: prettier --write $file"
                fi
            fi
        done
        
        if [ $PRETTIER_FAILED -eq 1 ]; then
            echo -e "${RED}‚ùå Prettier format check failed. Run prettier --write to fix formatting.${NC}"
            exit 1
        fi
        echo -e "${GREEN}‚úÖ Prettier format check passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Prettier not installed, skipping format check...${NC}"
    fi
    echo ""
fi

echo ""
echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo ""

exit 0
